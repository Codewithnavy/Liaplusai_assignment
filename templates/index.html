<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot with Sentiment Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div class="container py-4">
      <a class="skip-link" href="#chat">Skip to chat</a>
      <div class="card shadow-lg">
          <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">Liaplus — Chat & Sentiment</h4>
              <div class="d-flex gap-2 align-items-center">
                <div class="small text-light">Model: {{ model }}</div>
                {% if llm_available %}
                  <span class="badge llm-available">LLM available</span>
                {% else %}
                  <span class="badge llm-unavailable">LLM unavailable</span>
                {% endif %}
              </div>
            </div>
            {% if not llm_available %}
              <div class="w-100 mt-2">
                <div class="alert alert-warning mb-0 py-1" role="alert">
                  The LLM is not available — replies use a local fallback. Add an API key in <a href="/settings">Settings</a>. If you still see this after adding a key, check <a href="/status">Status</a> for quota or key errors.
                </div>
              </div>
            {% endif %}
            <div class="d-flex gap-2 align-items-center">
              <a href="/status" class="btn btn-sm btn-outline-light">Status</a>
              <a href="/settings" class="btn btn-sm btn-outline-light">Settings</a>
            </div>
          </div>
        </div>
        <div class="card-body chat-body" id="chat" role="log" aria-live="polite" tabindex="0">
          {% if history %}
            {% for msg in history %}
              {% if msg.role == 'user' %}
                <div class="d-flex mb-3 align-items-start">
                  <div class="avatar user" aria-hidden="true">You</div>
                  <div class="bubble user-bubble" role="article" tabindex="0" aria-label="User message at {{ msg.ts }}">
                    <div class="d-flex align-items-center gap-2">
                      <div class="message-text">{{ msg.text }}</div>
                      {% if msg.sentiment %}
                        <span class="badge sentiment-badge {{ msg.sentiment.label|lower }}">{{ msg.sentiment.label }}</span>
                      {% endif %}
                    </div>
                    {% if msg.ts %}
                      <div class="small text-muted mt-1 ts" data-iso="{{ msg.ts }}">{{ msg.ts }}</div>
                    {% endif %}
                  </div>
                </div>
              {% else %}
                <div class="d-flex mb-3 justify-content-end align-items-start">
                  <div class="bubble bot-bubble" role="article" tabindex="0" aria-label="Bot message at {{ msg.ts }}">
                    <div class="message-text">{{ msg.text }}</div>
                    <div class="d-flex gap-2 align-items-center mt-1">
                      {% if msg.model %}
                        <span class="badge bg-light text-dark model-badge" role="status" aria-label="Model {{ msg.model }}">{{ msg.model }}</span>
                      {% endif %}
                      {% if msg.ts %}
                        <div class="small text-muted ts" data-iso="{{ msg.ts }}">{{ msg.ts }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="avatar bot" aria-hidden="true">Bot</div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="text-muted">Start the conversation — ask a question or share feedback.</div>
          {% endif %}
        </div>
        <div class="card-footer">
          <form id="message-form" action="/message" method="post" class="d-flex gap-2 align-items-center">
            <label for="message-input" class="visually-hidden">Message</label>
            <input id="message-input" name="message" class="form-control" placeholder="Type your message" autocomplete="off" aria-label="Message" />
            <button class="btn btn-primary" type="submit" aria-label="Send message">Send</button>
            <button class="btn btn-outline-secondary" type="submit" formaction="/end" formmethod="post" aria-label="End conversation">End Conversation</button>
            <button class="btn btn-outline-danger" type="submit" formaction="/clear" formmethod="post" aria-label="Clear conversation">Clear</button>
          </form>
          <div class="mt-2 d-flex gap-2 align-items-center">
            <a class="btn btn-sm btn-light" href="/settings">Configure API Key & Model</a>
            <a class="btn btn-sm btn-outline-secondary" href="/troubleshoot">Troubleshooting</a>
          </div>
        </div>
      </div>
      <div class="mt-3 text-muted small">Conversation is stored temporarily in your session.</div>
      <div class="mt-2">
        <form action="/clear" method="post" style="display:inline">
          <button class="btn btn-sm btn-outline-secondary">Clear Conversation</button>
        </form>
      </div>
    </div>
  </body>
  <script>
    // Auto-scroll chat to bottom, format timestamps, show a temporary debug banner,
    // and keep keyboard submit behavior.
    (function(){
      const chat = document.getElementById('chat');
      if (chat) {
        // Move focus into chat for screen readers
        chat.focus();
        // delayed scroll to handle rendering timing
        setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 80);
      }

      // Friendly timestamp formatting for ISO strings
      document.querySelectorAll('.ts').forEach(el => {
        try {
          const iso = el.dataset.iso;
          if (!iso) return;
          const dt = new Date(iso);
          el.textContent = dt.toLocaleString();
        } catch (e) {
          // ignore
        }
      });

      // Observe chat container for new messages and scroll into view.
      try {
          if (chat) {
          const observer = new MutationObserver((mutations) => {
            for (const m of mutations) {
              if (m.addedNodes && m.addedNodes.length) {
                // scroll smoothly to the latest message
                const last = chat.querySelector('.bubble:last-of-type');
                if (last) {
                  last.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
              }
            }
          });
          observer.observe(chat, { childList: true, subtree: true });
        }
      } catch (e) {
        // ignore observer errors
      }

      // Submit on Enter and support AJAX submit to show replies immediately
      const form = document.getElementById('message-form');
      const input = document.getElementById('message-input');
      async function appendMessageToDOM(who, text, ts, model) {
        const wrap = document.createElement('div');
        if (who === 'user') {
          wrap.className = 'd-flex mb-3 align-items-start';
          // allow optional sentiment (pass model param as object for user: {sentiment:{label,compound}})
          let sentimentHtml = '';
          if (model && model.sentiment) {
            const lbl = model.sentiment.label || '';
            sentimentHtml = `<span class="badge sentiment-badge ${lbl.toLowerCase()}">${lbl}</span>`;
          }
          wrap.innerHTML = `<div class="avatar user" aria-hidden="true">You</div><div class="bubble user-bubble" role="article" tabindex="0" aria-label="User message at ${ts}"><div class="d-flex align-items-center gap-2"><div class="message-text">${text}</div>${sentimentHtml}</div><div class="small text-muted mt-1">${new Date(ts).toLocaleString()}</div></div>`;
        } else {
          wrap.className = 'd-flex mb-3 justify-content-end align-items-start';
          wrap.innerHTML = `<div class="bubble bot-bubble" role="article" tabindex="0" aria-label="Bot message at ${ts}"><div class="message-text">${text}</div><div class="d-flex gap-2 align-items-center mt-1">${model?`<span class="badge bg-light text-dark model-badge">${model}</span>`:''}<div class="small text-muted">${new Date(ts).toLocaleString()}</div></div></div><div class="avatar bot" aria-hidden="true">Bot</div>`;
        }
        chat.appendChild(wrap);
        // small delay then scroll
        setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 40);
        // show toast for bot replies
        if (who === 'bot') {
          try { showToast('Bot: ' + (text.length > 80 ? text.slice(0,80) + '…' : text)); } catch(e){}
          try {
            const sr = document.getElementById('sr-live');
            if (sr) sr.textContent = 'Bot: ' + (text.length > 200 ? text.slice(0,200) + '…' : text);
          } catch (e) {}
        }
      }

      // simple toast show/hide helper
      function showToast(msg, pos = 'bottom-right', timeout = 4200) {
        try {
          const s = loadSettings();
          if (!s.toastEnabled) return;
        } catch (e) {}
        const t = document.createElement('div');
        t.className = 'chat-toast ' + (pos || 'bottom-right');
        t.textContent = msg;
        document.body.appendChild(t);
        // allow CSS transitions
        setTimeout(() => t.classList.add('visible'), 60);
        // hide after timeout
        setTimeout(() => t.classList.remove('visible'), timeout);
        setTimeout(() => t.remove(), timeout + 300);
      }

      // small in-page settings (toast enable/position/timeout/sound)
      const chatSettingsKey = 'liaplus.chat.settings:v1';
      function defaultSettings() {
        return { toastEnabled: true, toastPos: 'bottom-right', toastTimeout: 4200, soundEnabled: false };
      }
      function loadSettings() {
        try { return Object.assign(defaultSettings(), JSON.parse(localStorage.getItem(chatSettingsKey) || '{}')); } catch(e) { return defaultSettings(); }
      }
      function saveSettings(s) { localStorage.setItem(chatSettingsKey, JSON.stringify(s)); }

      // create a small settings toggle UI
      (function createSettingsUI(){
        const s = loadSettings();
        const btn = document.createElement('button');
        btn.className = 'settings-gear';
        btn.setAttribute('aria-label','Chat settings');
        btn.title = 'Chat settings';
        btn.innerHTML = '⚙️';
        document.body.appendChild(btn);

        const panel = document.createElement('div');
        panel.className = 'settings-panel';
        panel.innerHTML = `
          <label><input type="checkbox" data-key="toastEnabled"> Enable toast</label>
          <label>Position: <select data-key="toastPos"><option value="bottom-right">Bottom right</option><option value="bottom-left">Bottom left</option><option value="top-right">Top right</option></select></label>
          <label>Timeout ms: <input type="number" data-key="toastTimeout" min="800" step="100" style="width:5.5rem"></label>
          <label><input type="checkbox" data-key="soundEnabled"> Play sound on reply</label>
          <div style="margin-top:0.5rem"><button class="btn-sm btn btn-primary save-settings">Save</button> <button class="btn-sm btn btn-secondary cancel-settings">Close</button></div>
        `;
        document.body.appendChild(panel);
        // populate
        panel.querySelector('[data-key="toastEnabled"]').checked = !!s.toastEnabled;
        panel.querySelector('[data-key="toastPos"]').value = s.toastPos;
        panel.querySelector('[data-key="toastTimeout"]').value = s.toastTimeout;
        panel.querySelector('[data-key="soundEnabled"]').checked = !!s.soundEnabled;

        btn.addEventListener('click', () => panel.classList.toggle('open'));
        panel.querySelector('.cancel-settings').addEventListener('click', () => panel.classList.remove('open'));
        panel.querySelector('.save-settings').addEventListener('click', () => {
          const ns = {
            toastEnabled: !!panel.querySelector('[data-key="toastEnabled"]').checked,
            toastPos: panel.querySelector('[data-key="toastPos"]').value,
            toastTimeout: parseInt(panel.querySelector('[data-key="toastTimeout"]').value,10) || 4200,
            soundEnabled: !!panel.querySelector('[data-key="soundEnabled"]').checked
          };
          saveSettings(ns);
          panel.classList.remove('open');
        });
      })();

      // play a short beep using WebAudio
      function playBeep() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine'; o.frequency.value = 880;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(ctx.destination);
          o.start();
          // ramp up and down
          g.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 0.01);
          g.gain.linearRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
          setTimeout(() => { try { o.stop(); ctx.close(); } catch(e){} }, 300);
        } catch (e) {
          // ignore audio errors
        }
      }

      if (form && input) {
        // prevent normal submit and use fetch with JSON
        form.addEventListener('submit', async function (e) {
          // If the user clicked a button that targets /end or /clear, allow normal form submission
          try {
            const submitter = e.submitter;
            const fa = submitter && (submitter.getAttribute('formaction') || submitter.formAction || '');
            if (fa && (fa.indexOf('/end') !== -1 || fa.indexOf('/clear') !== -1)) {
              // allow the browser to submit the form to the button's formaction
              return;
            }
          } catch (err) {
            // ignore and continue with AJAX
          }
          e.preventDefault();
          const text = input.value.trim();
          if (!text) return;
          // append user message immediately
          const now = new Date().toISOString();
          await appendMessageToDOM('user', text, now);
          input.value = '';

          try {
            const payload = { message: text };
            const resp = await fetch(form.action, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) {
              // fallback: reload page
              window.location = '/';
              return;
            }
            const data = await resp.json();
            // append bot reply (server returns {bot:{text,model,ts}})
            const bot = data.bot || {};
            await appendMessageToDOM('bot', bot.text || 'No reply', bot.ts || new Date().toISOString(), bot.model || '');
            // play beep or toast depending on settings
            const s = loadSettings();
            if (s.soundEnabled) playBeep();
            // If toast is enabled, show a toast (showToast checks setting again)
            if (s.toastEnabled) {
              showToast(bot.text ? ('Bot: ' + (bot.text.length>120?bot.text.slice(0,120)+'…':bot.text)) : 'Bot replied', s.toastPos, s.toastTimeout);
            }
          } catch (err) {
            console.error('Chat AJAX error', err);
            // reload fallback
            window.location = '/';
          }
        });

        // also submit on Enter
        input.addEventListener('keydown', function(e){
          if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            form.requestSubmit();
          }
        });
      }
    })();
  </script>
</html>
